---
import { sbGetBySlug, sbGetSlugsByPrefix } from "../../lib/storyblok";
import "../../styles/global.css";
import AddToCartPoc from "../../components/AddToCartPoc.vue";

export async function getStaticPaths() {
  const slugs = await sbGetSlugsByPrefix("product");
  return slugs.map((slug) => ({
    params: { slug },
  }));
}

const { slug } = Astro.params;
const story = await sbGetBySlug(`product/${slug}`);
const p = story.content;
---
<html lang="en">
  <head>
    <title>{p.name}</title>
  </head>
  <body class="min-h-screen bg-slate-50 text-slate-900">
    <div class="mx-auto flex min-h-screen max-w-6xl flex-col px-4 py-6 md:px-8">
      <header class="mb-6 flex items-center justify-between gap-4">
        <a
          href="/"
          class="inline-flex items-center text-sm font-medium text-sky-700 hover:text-sky-900"
        >
          <span class="mr-1 text-lg">‚Üê</span>
          <span>Back to overview</span>
        </a>
      </header>

      <main class="flex flex-1 flex-col gap-10 md:flex-row">
        <section class="flex-1">
          <h1 class="mb-3 text-3xl font-semibold tracking-tight text-slate-900 sm:text-4xl">
            {p.name}
          </h1>

          <div class="mb-4 flex flex-wrap items-center gap-3 text-sm text-slate-600">
            <span class="inline-flex items-center rounded-full bg-slate-100 px-3 py-1 text-xs font-medium">
              SKU: <span class="ml-1 font-semibold text-slate-900">{p.sku}</span>
            </span>

            {p.pdf_url && (
              <a
                href={p.pdf_url}
                target="_blank"
                rel="noreferrer"
                class="inline-flex items-center rounded-full bg-sky-600 px-4 py-1.5 text-xs font-semibold text-white shadow-sm transition hover:bg-sky-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-500 focus-visible:ring-offset-2"
              >
                View data sheet
              </a>
            )}
          </div>

          <p class="mb-6 max-w-xl text-sm leading-relaxed text-slate-700">{p.description}</p>
        </section>

        <aside class="flex-1 md:pl-6">
          <div
            class="rounded-2xl border border-slate-200 bg-white/80 p-4 shadow-sm"
            data-product-slug={slug}
            data-product-name={p.name}
            data-product-sku={p.sku}
          >
            {p.image_url && (
              <figure class="overflow-hidden rounded-xl border border-slate-100 bg-slate-50">
                <img
                  src={p.image_url}
                  alt={p.name}
                  class="mx-auto max-h-80 w-full max-w-md object-contain p-4"
                  loading="lazy"
                />
              </figure>
            )}

            {p.pdf_url && (
              <a
                href={p.pdf_url}
                target="_blank"
                rel="noreferrer"
                class="mt-4 inline-flex items-center justify-center rounded-lg bg-slate-900 px-4 py-2 text-xs font-semibold text-slate-50 hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-500 focus-visible:ring-offset-2"
              >
                Open data sheet (PDF)
              </a>
            )}

            <AddToCartPoc
              client:load
              productSlug={slug}
              productName={p.name}
              productSku={p.sku}
            />
          </div>
        </aside>
      </main>
      <script type="module">

        const container = document.querySelector("[data-product-slug]");
        const product = {
          slug: container?.getAttribute("data-product-slug") ?? "",
          name: container?.getAttribute("data-product-name") ?? "",
          sku: container?.getAttribute("data-product-sku") ?? "",
        };

        const qtyEl = document.getElementById("poc-qty");
        const minusBtn = document.getElementById("poc-qty-minus");
        const plusBtn = document.getElementById("poc-qty-plus");
        const notesEl = document.getElementById("poc-notes");
        const addBtn = document.getElementById("poc-add-to-cart");
        const messageEl = document.getElementById("poc-message");

        let qty = 1;
        const basePrice = 1 + Math.random() * 1;

        function updateQtyDisplay() {
          if (qtyEl) {
            qtyEl.textContent = String(qty);
          }
        }

        if (minusBtn) {
          minusBtn.addEventListener("click", () => {
            if (qty > 1) {
              qty -= 1;
              updateQtyDisplay();
            }
          });
        }

        if (plusBtn) {
          plusBtn.addEventListener("click", () => {
            qty += 1;
            updateQtyDisplay();
          });
        }

        if (addBtn) {
          addBtn.addEventListener("click", () => {
            const notes =
              notesEl && notesEl instanceof HTMLTextAreaElement
                ? notesEl.value.trim()
                : "";

            const api = window.rlsCart;
            if (api && product.sku && product.slug && product.name) {
              const partNumber = `${product.sku}-CONF`;
              const options = [{ code: "example", value: "value" }];

              api.addItem({
                productSlug: product.slug,
                productName: product.name,
                baseSku: product.sku,
                partNumber,
                price: basePrice,
                qty,
                options,
                notes: notes || undefined,
              });
            }

            if (messageEl) {
              messageEl.innerHTML =
                'Item added to cart. <a href="/cart" class="underline">View cart</a>.';
            }
          });
        }

        updateQtyDisplay();
      </script>
    </div>
  </body>
</html>